<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
      integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .player {
        display: flex;
        gap: 1rem;
      }
      .player-ready-state {
        background-color: white;
        border: 1px solid black;
        color: red;
      }
      .player-ready-state.ready {
        color: green;
      }
    </style>
    <title>ChatCord App</title>
  </head>
  <body>
    <div class="chat-container">
      <header class="chat-header">
        <h1><i class="fas fa-smile"></i> Coup Game</h1>
        <button class="ready-btn">toggle ready state</button>
        <button class="btn leave-btn">Leave Room</button>
      </header>
      <main class="chat-main">
        <div class="chat-sidebar">
          <h3><i class="fas fa-comments"></i> Room Name:</h3>
          <h2 id="room-name"></h2>
          <h3><i class="fas fa-users"></i> Players</h3>
          <ul id="player-list">
            <template>
              <li class="player">
                <span class="player-name">Ivan</span>
                <div class="player-ready-state">READY</div>
              </li>
            </template>
          </ul>
        </div>
        <div class="chat-messages"></div>
      </main>
      <div class="chat-form-container">
        <form id="chat-form">
          <input
            id="msg"
            type="text"
            placeholder="Enter Message"
            required
            autocomplete="off"
          />
          <button class="btn"><i class="fas fa-paper-plane"></i> Send</button>
        </form>
      </div>
    </div>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.11.1/qs.min.js"
      integrity="sha512-5Zv/hNtOKSkeScnIYOqGjng82gQSHsCoyqq9TgrJLgYa032cUYWH4kF1ayS8Gz1Jfge7e8MaBF6AeEvoQ92v8w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const chatForm = document.querySelector("#chat-form");
      const chatMessages = document.querySelector(".chat-messages");
      const roomName = document.querySelector("#room-name");
      const playerList = document.querySelector("#player-list");
      const leaveBtn = document.querySelector(".leave-btn");
      let template = document.querySelector("template");
      let readyBtn = document.querySelector(".ready-btn");
      let clientSocketID = "";
      // create a post request to change the player ready status
      readyBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        const obj = {};
        obj.id = clientSocketID;
        const res = await fetch("/player/ready", {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(obj),
        });
      });

      // emit a leave event when the user refreshed the page
      window.addEventListener("beforeunload", (event) => {
        socket.emit("leave-room", rid);
      });
      // Get username and room from URL
      const { username, room, rid } = Qs.parse(location.search, {
        ignoreQueryPrefix: true,
      });

      const socket = io();

      // socket on connect get the socketID
      socket.on("connect", () => {
        clientSocketID = socket.id;
      });

      // Join chatroom
      socket.emit("join-room", { username, room, rid });

      // Get room and users
      socket.on("room-players", ({ room, players }) => {
        outputRoomName(room);
        outputPlayers(players);
      });

      // Message from server
      socket.on("message", (message) => {
        outputMessage(message);

        // Scroll down
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });

      // Message submit
      chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        // Get message text
        const msg = e.target.elements.msg.value;

        // Emit message to server
        socket.emit("chatMessage", msg);

        // Clear input
        e.target.elements.msg.value = "";
        e.target.elements.msg.focus();
      });
      // start the game when all ready
      socket.on("redirect-to-game", () => {
        location.href = "game.html";
      });
      // Leave button decrement room count and direct back to lobby
      leaveBtn.addEventListener("click", () => {
        socket.emit("leave-room", rid);
        location.href = "/user/gameroom.html";
      });

      // Output message to DOM

      function outputMessage(message) {
        const div = document.createElement("div");
        div.classList.add("message");
        div.innerHTML = `<p class="meta">${message.username} <span>${message.time}</span></p>
      <p class="text">
       ${message.text}
      </p>`;
        document.querySelector(".chat-messages").appendChild(div);
      }

      // Add room name to DOM
      function outputRoomName(room) {
        roomName.innerText = room;
      }

      // Add users to DOM
      function outputPlayers(players) {
        clearAllChildNode(playerList);
        players.map((player) => {
          let playerNode = template.content
            .querySelector(".player")
            .cloneNode(true);
          playerNode.querySelector(".player-name").textContent =
            player.username;
          let playerReadyState = playerNode.querySelector(
            ".player-ready-state"
          );
          playerNode.querySelector(".player-ready-state");
          if (player.ready) {
            playerReadyState.textContent = "READY";
            playerReadyState.classList.add("ready");
          } else {
            playerReadyState.textContent = "NOT READY";
            playerReadyState.classList.remove("ready");
          }
          playerList.appendChild(playerNode);
        });

        //       userList.innerHTML = `
        //   ${users.map((user) => `<li>${user.username}</li>`).join("")}
        // `;
      }

      function clearAllChildNode(parent) {
        while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
        }
      }
    </script>
  </body>
</html>
